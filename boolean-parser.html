<!DOCTYPE html>
<html lang="en" class="doc-page">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Primer - Search Filter Builder</title>
  
  <!-- CSS Reset & Variables -->
  <link rel="stylesheet" href="css/variables.css">
  <link rel="stylesheet" href="css/reset.css">

  <!-- Base Styles -->
  <link rel="stylesheet" href="css/typography.css">
  <link rel="stylesheet" href="css/layout.css">
  <link rel="stylesheet" href="css/navigation.css">

  <!-- Components -->
  <link rel="stylesheet" href="css/cards.css">
  <link rel="stylesheet" href="css/forms.css">
  <link rel="stylesheet" href="css/components.css">

  <!-- Documentation Pages -->
  <link rel="stylesheet" href="css/documentation.css">

  <!-- Utilities (last for override capability) -->
  <link rel="stylesheet" href="css/utilities.css">

  <style>
    .filter-builder {
      max-width: 1100px;
      margin: 0 auto;
    }

    /* Mode Tabs */
    .mode-tabs {
      display: flex;
      gap: 2px;
      margin-bottom: var(--space-lg);
      background: var(--bg-tertiary);
      padding: 3px;
      border-radius: var(--border-radius);
      width: fit-content;
    }

    .mode-tab {
      padding: var(--space-sm) var(--space-xl);
      background: transparent;
      border: none;
      border-radius: 2px;
      font-size: var(--text-sm);
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .mode-tab:hover {
      color: var(--text-primary);
    }

    .mode-tab.active {
      background: var(--bg-secondary);
      color: var(--text-primary);
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .mode-panel {
      display: none;
    }

    .mode-panel.active {
      display: block;
    }

    /* Simple Mode */
    .simple-mode-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      padding: var(--space-lg);
    }

    .simple-operator-row {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .simple-operator-label {
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }

    .operator-toggle {
      display: flex;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      overflow: hidden;
    }

    .operator-toggle-btn {
      padding: var(--space-xs) var(--space-md);
      background: transparent;
      border: none;
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.15s ease;
    }

    .operator-toggle-btn:not(:last-child) {
      border-right: 1px solid var(--border-color);
    }

    .operator-toggle-btn.active {
      background: var(--accent-primary);
      color: white;
    }

    .operator-toggle-btn:hover:not(.active) {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .simple-chips-area {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-sm);
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      min-height: 52px;
      margin-bottom: var(--space-lg);
    }

    .filter-chip {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--border-radius);
      font-size: var(--text-xs);
    }

    .filter-chip-icon {
      font-size: 11px;
    }

    .filter-chip .remove {
      cursor: pointer;
      opacity: 0.5;
      font-size: 14px;
      line-height: 1;
      margin-left: var(--space-xs);
    }

    .filter-chip .remove:hover {
      opacity: 1;
    }

    .simple-add-input {
      flex: 1;
      min-width: 180px;
      background: transparent;
      border: none;
      font-size: var(--text-xs);
      color: var(--text-primary);
      outline: none;
    }

    .simple-add-input::placeholder {
      color: var(--text-muted);
    }

    /* Entity Accordions */
    .entity-accordions {
      border-top: 1px solid var(--border-subtle);
      padding-top: var(--space-lg);
    }

    .entity-accordion {
      border: 1px solid var(--border-subtle);
      border-radius: var(--border-radius);
      margin-bottom: var(--space-sm);
      overflow: hidden;
    }

    .entity-accordion-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-tertiary);
      cursor: pointer;
      user-select: none;
    }

    .entity-accordion-header:hover {
      background: var(--bg-hover);
    }

    .entity-accordion-left {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .entity-accordion-chevron {
      transition: transform 0.15s ease;
      color: var(--text-muted);
    }

    .entity-accordion.expanded .entity-accordion-chevron {
      transform: rotate(180deg);
    }

    .entity-accordion-label {
      font-size: var(--text-sm);
      font-weight: 500;
    }

    .entity-accordion-count {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .entity-accordion-add-all {
      font-size: var(--text-xs);
      color: var(--accent-primary);
      background: none;
      border: none;
      cursor: pointer;
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--border-radius);
    }

    .entity-accordion-add-all:hover {
      background: var(--accent-muted);
    }

    .entity-accordion-body {
      display: none;
      padding: var(--space-sm);
      background: var(--bg-secondary);
      border-top: 1px solid var(--border-subtle);
      max-height: 180px;
      overflow-y: auto;
    }

    .entity-accordion.expanded .entity-accordion-body {
      display: block;
    }

    .entity-accordion-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: var(--text-xs);
      color: var(--text-secondary);
    }

    .entity-accordion-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .entity-accordion-item-add {
      color: var(--accent-primary);
      font-weight: 600;
    }

    /* Advanced Mode */
    .advanced-layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-lg);
    }

    @media (max-width: 900px) {
      .advanced-layout {
        grid-template-columns: 1fr;
      }
    }

    .advanced-panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
    }

    .advanced-panel-header {
      padding: var(--space-sm) var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .advanced-panel-body {
      flex: 1;
      padding: var(--space-md);
      min-height: 280px;
      position: relative;
    }

    /* Contenteditable Editor */
    .rich-editor {
      width: 100%;
      min-height: 200px;
      padding: var(--space-md);
      font-family: var(--font-mono);
      font-size: var(--text-sm);
      line-height: 1.8;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      color: var(--text-primary);
      outline: none;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .rich-editor:focus {
      border-color: var(--accent-primary);
    }

    .rich-editor:empty::before {
      content: attr(data-placeholder);
      color: var(--text-muted);
      pointer-events: none;
    }

    /* Entity Chip (inline, non-editable) */
    .entity-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      margin: 0 2px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      font-family: var(--font-sans);
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      user-select: none;
      vertical-align: middle;
    }

    .entity-chip:hover {
      border-color: var(--accent-primary);
      background: var(--accent-muted);
    }

    /* Error Marker */
    .error-marker {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 8px;
      height: 16px;
      margin: 0 1px;
      color: var(--accent-danger);
      font-weight: bold;
      font-size: 14px;
      animation: error-pulse 1s ease-in-out infinite;
      vertical-align: middle;
    }

    .error-marker::after {
      content: '‚ñº';
      font-size: 10px;
    }

    @keyframes error-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .error-context {
      background: rgba(220, 38, 38, 0.1);
      border-bottom: 2px wavy var(--accent-danger);
      padding: 0 2px;
      margin: 0 -2px;
    }

    .entity-chip svg {
      width: 12px;
      height: 12px;
      flex-shrink: 0;
    }

    .entity-chip.org {
      border-color: rgba(49, 105, 237, 0.3);
      background: rgba(49, 105, 237, 0.08);
    }

    .entity-chip.org:hover {
      background: rgba(49, 105, 237, 0.15);
    }

    .entity-chip.person {
      border-color: rgba(168, 85, 247, 0.3);
      background: rgba(168, 85, 247, 0.08);
    }

    .entity-chip.person:hover {
      background: rgba(168, 85, 247, 0.15);
    }

    /* Operator styling in editor */
    .op-and, .op-or, .op-not {
      font-weight: 700;
      padding: 0 2px;
    }

    .op-and { color: var(--accent-success); }
    .op-or { color: var(--accent-primary); }
    .op-not { color: var(--accent-danger); }

    /* Parentheses styling */
    .paren {
      font-weight: 700;
      color: var(--accent-primary);
      font-size: 1.1em;
    }

    /* Popups */
    .editor-popup {
      position: absolute;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
    }

    .editor-popup.visible {
      display: block;
    }

    /* Entity Typeahead Popup */
    .typeahead-popup {
      max-height: 240px;
      width: 240px;
      overflow-y: auto;
    }

    .typeahead-header {
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--border-subtle);
      font-size: 10px;
      color: var(--text-muted);
    }

    .typeahead-header strong {
      color: var(--text-primary);
    }

    .typeahead-section {
      padding: var(--space-xs) 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .typeahead-section:last-child {
      border-bottom: none;
    }

    .typeahead-section-label {
      padding: var(--space-xs) var(--space-sm);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .typeahead-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: 6px var(--space-sm);
      cursor: pointer;
      font-size: var(--text-xs);
    }

    .typeahead-item:hover,
    .typeahead-item.selected {
      background: var(--bg-hover);
    }

    .typeahead-item svg {
      width: 14px;
      height: 14px;
      flex-shrink: 0;
    }


    /* Editor Hints */
    .editor-hints {
      display: flex;
      gap: var(--space-lg);
      padding: var(--space-sm) var(--space-md);
      font-size: var(--text-xs);
      color: var(--text-muted);
      border-top: 1px solid var(--border-subtle);
      background: var(--bg-tertiary);
    }

    .editor-hint {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
    }

    .hint-key {
      padding: 2px 6px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 3px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
    }

    /* Status */
    .editor-status {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-subtle);
      font-size: var(--text-xs);
    }

    .editor-status.valid { color: var(--accent-success); }
    .editor-status.error { color: var(--accent-danger); }

    /* Parsed Tree */
    .parsed-tree {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      line-height: 1.8;
      padding: var(--space-sm);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      min-height: 200px;
      max-height: 400px;
      overflow: auto;
    }

    .tree-empty {
      color: var(--text-muted);
      font-family: var(--font-sans);
      text-align: center;
      padding: var(--space-2xl);
    }

    .tree-node {
      padding-left: var(--space-xl);
      position: relative;
    }

    .tree-node::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0.9em;
      width: 1px;
      background: var(--border-color);
    }

    .tree-node::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0.9em;
      width: var(--space-lg);
      height: 1px;
      background: var(--border-color);
    }

    .tree-node:last-child::before {
      bottom: calc(100% - 0.9em);
    }

    .tree-root {
      padding-left: 0;
    }

    .tree-root::before,
    .tree-root::after {
      display: none;
    }

    .operator-badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
      font-size: 10px;
      text-transform: uppercase;
      margin-bottom: var(--space-xs);
    }

    .operator-and { background: rgba(22, 163, 74, 0.15); color: var(--accent-success); }
    .operator-or { background: rgba(49, 105, 237, 0.15); color: var(--accent-primary); }
    .operator-not { background: rgba(220, 38, 38, 0.15); color: var(--accent-danger); }

    .node-term {
      display: inline-flex;
      align-items: center;
      gap: var(--space-xs);
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--border-radius);
      font-size: var(--text-xs);
    }

    /* Footer Actions */
    .filter-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-lg);
      padding-top: var(--space-lg);
      border-top: 1px solid var(--border-subtle);
    }

    .filter-actions-left {
      display: flex;
      gap: var(--space-sm);
    }

    .filter-actions-right {
      display: flex;
      gap: var(--space-sm);
    }

    .advanced-accordions {
      margin-top: var(--space-lg);
    }

    /* Save Filter Dialog */
    .save-dialog-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, visibility 0.15s ease;
    }

    .save-dialog-overlay.visible {
      opacity: 1;
      visibility: visible;
    }

    .save-dialog {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-lg);
      box-shadow: var(--shadow-xl);
      width: 100%;
      max-width: 440px;
      transform: scale(0.95) translateY(-10px);
      transition: transform 0.15s ease;
    }

    .save-dialog-overlay.visible .save-dialog {
      transform: scale(1) translateY(0);
    }

    .save-dialog-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md) var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
    }

    .save-dialog-header h3 {
      font-size: var(--text-base);
      font-weight: 600;
      margin: 0;
    }

    .save-dialog-close {
      background: none;
      border: none;
      font-size: 20px;
      color: var(--text-muted);
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }

    .save-dialog-close:hover {
      color: var(--text-primary);
    }

    .save-dialog-body {
      padding: var(--space-lg);
    }

    .save-dialog-description {
      font-size: var(--text-sm);
      color: var(--text-secondary);
      margin-bottom: var(--space-md);
      line-height: 1.5;
    }

    .save-dialog-summary {
      font-size: var(--text-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-tertiary);
      border-radius: var(--border-radius);
      margin-bottom: var(--space-lg);
    }

    .save-dialog-summary strong {
      color: var(--accent-primary);
    }

    .save-dialog-body .form-group {
      margin-bottom: var(--space-md);
    }

    .save-dialog-body .form-group:last-child {
      margin-bottom: 0;
    }

    .save-dialog-body .form-label {
      display: block;
      font-size: var(--text-sm);
      font-weight: 500;
      margin-bottom: var(--space-xs);
    }

    .save-dialog-body .form-label .required {
      color: var(--accent-danger);
    }

    .save-dialog-body .form-label .optional {
      color: var(--text-muted);
      font-weight: 400;
    }

    .save-dialog-footer {
      display: flex;
      justify-content: flex-end;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      border-top: 1px solid var(--border-subtle);
      background: var(--bg-tertiary);
      border-radius: 0 0 var(--border-radius-lg) var(--border-radius-lg);
    }

    /* Preview of what will be saved */
    .save-dialog-preview {
      margin-top: var(--space-md);
      padding: var(--space-md);
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--border-radius);
      max-height: 120px;
      overflow-y: auto;
    }

    .save-dialog-preview-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: var(--space-xs);
    }

    .save-dialog-preview-content {
      font-family: var(--font-mono);
      font-size: var(--text-xs);
      color: var(--text-secondary);
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Form Input Error State */
    .form-input.input-error {
      border-color: var(--accent-danger);
      box-shadow: 0 0 0 3px rgba(220, 38, 38, 0.15);
      animation: shake 0.3s ease-in-out;
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-4px); }
      75% { transform: translateX(4px); }
    }
  </style>
</head>
<body>
  <nav class="top-navbar">
    <div class="navbar-left">
      <a href="index.html#/dashboard" class="logo">
        <img src="img/logo.png" alt="Primer" class="logo-img">
      </a>
      
      <div class="navbar-links">
        <a href="index.html#/dashboard" class="nav-link">
          <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
            <rect x="1" y="1" width="6" height="6" rx="1"/>
            <rect x="9" y="1" width="6" height="6" rx="1"/>
            <rect x="1" y="9" width="6" height="6" rx="1"/>
            <rect x="9" y="9" width="6" height="6" rx="1"/>
          </svg>
          <span>Dashboard</span>
        </a>
        <a href="index.html#/monitors" class="nav-link">
          <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
            <rect x="1" y="2" width="14" height="10" rx="1"/>
            <path d="M5 14h6M8 12v2"/>
            <path d="M4 6h2M4 8h3M10 5l2 2-2 2"/>
          </svg>
          <span>Monitors</span>
        </a>
        <a href="index.html#/workspaces" class="nav-link">
          <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
            <rect x="1" y="1" width="14" height="14" rx="1"/>
            <path d="M1 5h14"/>
            <path d="M5 5v10"/>
          </svg>
          <span>Workspaces</span>
        </a>
        <a href="index.html#/search" class="nav-link">
          <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
            <circle cx="7" cy="7" r="4.5"/>
            <path d="M10.5 10.5L14 14"/>
          </svg>
          <span>Search</span>
        </a>
      </div>
    </div>
    
    <div class="navbar-right">
      <div class="nav-dropdown data-dropdown">
        <button class="nav-dropdown-trigger">
          <span>Data</span>
          <svg class="dropdown-arrow" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
            <path d="M4 6l4 4 4-4"/>
          </svg>
        </button>
        <div class="nav-dropdown-menu">
          <a href="index.html#/narratives" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <path d="M2 2h12v12H2z" rx="1"/>
              <path d="M4 5h8M4 8h8M4 11h5"/>
            </svg>
            <span>Narratives</span>
          </a>
          <a href="index.html#/factions" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <circle cx="8" cy="5" r="2.5"/>
              <circle cx="4" cy="11" r="2"/>
              <circle cx="12" cy="11" r="2"/>
              <path d="M6 6.5L4.5 9M10 6.5l1.5 2.5"/>
            </svg>
            <span>Factions</span>
          </a>
          <a href="index.html#/locations" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <path d="M8 1C5.2 1 3 3.2 3 6c0 4 5 9 5 9s5-5 5-9c0-2.8-2.2-5-5-5z"/>
              <circle cx="8" cy="6" r="2"/>
            </svg>
            <span>Locations</span>
          </a>
          <a href="index.html#/events" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <rect x="2" y="3" width="12" height="11" rx="1"/>
              <path d="M2 6h12M5 1v3M11 1v3"/>
            </svg>
            <span>Events</span>
          </a>
          <a href="index.html#/entities" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <circle cx="8" cy="4" r="2.5"/>
              <path d="M3 14c0-3 2.2-5 5-5s5 2 5 5"/>
            </svg>
            <span>People & Orgs</span>
          </a>
        </div>
      </div>
      
      <div class="nav-dropdown avatar-dropdown">
        <button class="avatar-trigger">
          <span class="avatar-initials">JD</span>
        </button>
        <div class="nav-dropdown-menu avatar-menu">
          <div class="avatar-menu-header">
            <span class="avatar-name">Jane Doe</span>
            <span class="avatar-email">jane.doe@primer.ai</span>
          </div>
          <div class="avatar-menu-divider"></div>
          <a href="data-model.html" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <ellipse cx="8" cy="4" rx="5" ry="2"/>
              <path d="M3 4v8c0 1.1 2.2 2 5 2s5-.9 5-2V4"/>
              <path d="M3 8c0 1.1 2.2 2 5 2s5-.9 5-2"/>
            </svg>
            <span>Data Model</span>
          </a>
          <a href="component-demos.html" class="nav-link">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <rect x="1" y="1" width="5" height="5" rx="1"/>
              <rect x="10" y="1" width="5" height="5" rx="1"/>
              <rect x="1" y="10" width="5" height="5" rx="1"/>
              <rect x="10" y="10" width="5" height="5" rx="1"/>
            </svg>
            <span>Component Demos</span>
          </a>
          <a href="boolean-parser.html" class="nav-link active">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <path d="M3 3h10v2H3zM3 7h6v2H3zM9 7h4v2H9zM3 11h10v2H3z"/>
            </svg>
            <span>Filter Builder</span>
          </a>
          <div class="avatar-menu-divider"></div>
          <a href="index.html" class="nav-link" title="Settings available in main app">
            <svg class="nav-icon" viewBox="0 0 16 16" fill="none" stroke="var(--text-secondary)" stroke-width="1">
              <circle cx="8" cy="8" r="2.5"/>
              <path d="M8 1v2M8 13v2M1 8h2M13 8h2M2.9 2.9l1.4 1.4M11.7 11.7l1.4 1.4M2.9 13.1l1.4-1.4M11.7 4.3l1.4-1.4"/>
            </svg>
            <span>Settings</span>
          </a>
        </div>
      </div>
    </div>
  </nav>

  <main class="doc-main">
    <div class="page-intro">
      <h1 class="page-title">Search Filter Builder</h1>
      <p class="page-description">Build filters using entities and keywords. Use Simple mode for quick filters, or Advanced mode for complex boolean expressions.</p>
    </div>

    <div class="filter-builder">
      <!-- Mode Tabs -->
      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="simple">Simple</button>
        <button class="mode-tab" data-mode="advanced">Advanced</button>
      </div>

      <!-- Simple Mode -->
      <div class="mode-panel active" id="simple-mode">
        <div class="simple-mode-content">
          <div class="simple-operator-row">
            <span class="simple-operator-label">Match documents with</span>
            <div class="operator-toggle" id="simple-operator">
              <button class="operator-toggle-btn" data-op="AND">ALL</button>
              <button class="operator-toggle-btn active" data-op="OR">ANY</button>
            </div>
            <span class="simple-operator-label">of these:</span>
          </div>

          <div class="simple-chips-area" id="simple-chips">
            <input type="text" class="simple-add-input" placeholder="Search entities or type keyword + Enter..." id="simple-input">
          </div>

          <!-- Entity Accordions -->
          <div class="entity-accordions" id="simple-accordions">
            <div class="entity-accordion" data-type="organizations">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">üè¢</span>
                  <span class="entity-accordion-label">Organizations</span>
                  <span class="entity-accordion-count">(7)</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="SMIC" data-type="org"><span class="entity-accordion-item-add">+</span> SMIC</div>
                <div class="entity-accordion-item" data-name="Huawei" data-type="org"><span class="entity-accordion-item-add">+</span> Huawei</div>
                <div class="entity-accordion-item" data-name="TSMC" data-type="org"><span class="entity-accordion-item-add">+</span> TSMC</div>
                <div class="entity-accordion-item" data-name="Intel" data-type="org"><span class="entity-accordion-item-add">+</span> Intel</div>
                <div class="entity-accordion-item" data-name="NVIDIA" data-type="org"><span class="entity-accordion-item-add">+</span> NVIDIA</div>
                <div class="entity-accordion-item" data-name="ASML" data-type="org"><span class="entity-accordion-item-add">+</span> ASML</div>
                <div class="entity-accordion-item" data-name="Samsung" data-type="org"><span class="entity-accordion-item-add">+</span> Samsung</div>
              </div>
            </div>
            <div class="entity-accordion" data-type="persons">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">üë§</span>
                  <span class="entity-accordion-label">Persons</span>
                  <span class="entity-accordion-count">(4)</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="Jensen Huang" data-type="person"><span class="entity-accordion-item-add">+</span> Jensen Huang</div>
                <div class="entity-accordion-item" data-name="Ren Zhengfei" data-type="person"><span class="entity-accordion-item-add">+</span> Ren Zhengfei</div>
                <div class="entity-accordion-item" data-name="Morris Chang" data-type="person"><span class="entity-accordion-item-add">+</span> Morris Chang</div>
                <div class="entity-accordion-item" data-name="Pat Gelsinger" data-type="person"><span class="entity-accordion-item-add">+</span> Pat Gelsinger</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Mode -->
      <div class="mode-panel" id="advanced-mode">
        <div class="advanced-layout">
          <!-- Rich Editor Panel -->
          <div class="advanced-panel">
            <div class="advanced-panel-header">Boolean Expression</div>
            <div class="advanced-panel-body">
              <div class="rich-editor" 
                   id="rich-editor" 
                   contenteditable="true"
                   data-placeholder="Type @ to insert entity, ( to start group..."></div>
              
              <!-- Typeahead Popup -->
              <div class="editor-popup typeahead-popup" id="typeahead-popup"></div>
              
            </div>
            <div class="editor-hints">
              <span class="editor-hint"><span class="hint-key">@</span> insert entity</span>
              <span class="editor-hint"><span class="hint-key">(</span> start group</span>
              <span class="editor-hint"><span class="hint-key">Enter</span> select</span>
              <span class="editor-hint"><span class="hint-key">Esc</span> dismiss</span>
            </div>
            <div class="editor-status valid" id="editor-status">
              <span>‚úì</span>
              <span>Ready ‚Äî type @ to insert an entity</span>
            </div>
          </div>

          <!-- Parsed Structure Panel -->
          <div class="advanced-panel">
            <div class="advanced-panel-header">Parsed Structure</div>
            <div class="advanced-panel-body">
              <div class="parsed-tree" id="parsed-tree">
                <div class="tree-empty">Start building to see expression structure</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Entity Accordions for Advanced Mode -->
        <div class="advanced-accordions">
          <div class="simple-mode-content" style="margin-top: var(--space-lg);">
            <p class="text-sm text-muted" style="margin-bottom: var(--space-md);">Click an entity to insert at cursor:</p>
            <div class="entity-accordions" id="advanced-accordions">
              <div class="entity-accordion" data-type="organizations">
                <div class="entity-accordion-header">
                  <div class="entity-accordion-left">
                    <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                    <span class="filter-chip-icon">üè¢</span>
                    <span class="entity-accordion-label">Organizations</span>
                  </div>
                </div>
                <div class="entity-accordion-body">
                  <div class="entity-accordion-item" data-name="SMIC" data-type="org"><span class="entity-accordion-item-add">+</span> SMIC</div>
                  <div class="entity-accordion-item" data-name="Huawei" data-type="org"><span class="entity-accordion-item-add">+</span> Huawei</div>
                  <div class="entity-accordion-item" data-name="TSMC" data-type="org"><span class="entity-accordion-item-add">+</span> TSMC</div>
                  <div class="entity-accordion-item" data-name="Intel" data-type="org"><span class="entity-accordion-item-add">+</span> Intel</div>
                  <div class="entity-accordion-item" data-name="NVIDIA" data-type="org"><span class="entity-accordion-item-add">+</span> NVIDIA</div>
                  <div class="entity-accordion-item" data-name="ASML" data-type="org"><span class="entity-accordion-item-add">+</span> ASML</div>
                </div>
              </div>
              <div class="entity-accordion" data-type="persons">
                <div class="entity-accordion-header">
                  <div class="entity-accordion-left">
                    <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                    <span class="filter-chip-icon">üë§</span>
                    <span class="entity-accordion-label">Persons</span>
                  </div>
                </div>
                <div class="entity-accordion-body">
                  <div class="entity-accordion-item" data-name="Jensen Huang" data-type="person"><span class="entity-accordion-item-add">+</span> Jensen Huang</div>
                  <div class="entity-accordion-item" data-name="Ren Zhengfei" data-type="person"><span class="entity-accordion-item-add">+</span> Ren Zhengfei</div>
                  <div class="entity-accordion-item" data-name="Morris Chang" data-type="person"><span class="entity-accordion-item-add">+</span> Morris Chang</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Footer Actions -->
      <div class="filter-actions">
        <div class="filter-actions-left">
          <button class="btn" id="clear-btn">Clear All</button>
        </div>
        <div class="filter-actions-right">
          <button class="btn">Preview Results</button>
          <button class="btn btn-primary">Save Filter</button>
        </div>
      </div>
    </div>

    <!-- Divider -->
    <hr style="margin: var(--space-2xl) 0; border: none; border-top: 1px solid var(--border-color);">

    <!-- Current Implementation: ScopeSelector -->
    <div class="page-intro">
      <h2 class="section-title">Current Implementation: ScopeSelector</h2>
      <p class="page-description">This is how the existing filter component works. It uses a flat chip-based approach without boolean logic.</p>
    </div>

    <div class="filter-builder">
      <div class="simple-mode-content" id="scope-selector-demo">
        <!-- Scope Selector Mock -->
        <div class="scope-selector">
          <!-- Search Input -->
          <div class="scope-search-wrapper" style="margin-bottom: var(--space-md);">
            <input 
              type="text" 
              class="form-input scope-search-input" 
              id="scope-demo-search"
              placeholder="Search entities or add keyword..."
            />
          </div>
          
          <!-- Selected Items (chips) -->
          <div class="scope-chips-container" style="display: flex; align-items: flex-start; gap: var(--space-sm); margin-bottom: var(--space-lg);">
            <div class="scope-chips" id="scope-demo-chips" style="display: flex; flex-wrap: wrap; gap: var(--space-xs); flex: 1; min-height: 32px; padding: var(--space-sm); background: var(--bg-tertiary); border-radius: var(--border-radius); border: 1px solid var(--border-color);">
              <span class="scope-chips-empty" style="color: var(--text-muted); font-size: var(--text-xs);">No items selected</span>
            </div>
            <button 
              class="btn-icon scope-save-filter-btn" 
              title="Save as search filter"
              disabled
              style="padding: var(--space-xs); background: var(--bg-tertiary); border: 1px solid var(--border-color); border-radius: var(--border-radius); cursor: pointer;"
            >
              <svg viewBox="0 0 16 16" width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M3 2a1 1 0 00-1 1v11.5l6-3 6 3V3a1 1 0 00-1-1H3z"/>
                <path d="M8 5v4M6 7h4" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          
          <!-- Entity List with Accordions -->
          <div class="scope-entity-list">
            <!-- Search Filters Accordion -->
            <div class="entity-accordion" data-type="searchFilters">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <svg viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5" style="margin-right: 4px;">
                    <path d="M1 2h14l-5 6v5l-4 2V8L1 2z"/>
                  </svg>
                  <span class="entity-accordion-label">Search Filters</span>
                  <span class="entity-accordion-count">3 saved</span>
                </div>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item scope-filter-item" data-filter="china-leaders">
                  <svg viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M1 2h14l-5 6v5l-4 2V8L1 2z"/>
                  </svg>
                  <span>China Tech Leaders</span>
                  <span class="text-muted" style="margin-left: auto; font-size: 10px;">5 items</span>
                  <span style="color: var(--accent-primary); font-weight: 500; margin-left: var(--space-sm);">Add</span>
                </div>
                <div class="entity-accordion-item scope-filter-item" data-filter="export-keywords">
                  <svg viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M1 2h14l-5 6v5l-4 2V8L1 2z"/>
                  </svg>
                  <span>Export Control Keywords</span>
                  <span class="text-muted" style="margin-left: auto; font-size: 10px;">12 items</span>
                  <span style="color: var(--accent-primary); font-weight: 500; margin-left: var(--space-sm);">Add</span>
                </div>
                <div class="entity-accordion-item scope-filter-item" data-filter="semicond-cos">
                  <svg viewBox="0 0 16 16" width="14" height="14" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M1 2h14l-5 6v5l-4 2V8L1 2z"/>
                  </svg>
                  <span>Semiconductor Companies</span>
                  <span class="text-muted" style="margin-left: auto; font-size: 10px;">8 items</span>
                  <span style="color: var(--accent-primary); font-weight: 500; margin-left: var(--space-sm);">Add</span>
                </div>
              </div>
            </div>

            <!-- Persons Accordion -->
            <div class="entity-accordion" data-type="persons">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">üë§</span>
                  <span class="entity-accordion-label">Persons</span>
                  <span class="entity-accordion-count">4</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="Jensen Huang" data-type="person"><span class="entity-accordion-item-add">+</span> Jensen Huang</div>
                <div class="entity-accordion-item" data-name="Ren Zhengfei" data-type="person"><span class="entity-accordion-item-add">+</span> Ren Zhengfei</div>
                <div class="entity-accordion-item" data-name="Morris Chang" data-type="person"><span class="entity-accordion-item-add">+</span> Morris Chang</div>
                <div class="entity-accordion-item" data-name="Pat Gelsinger" data-type="person"><span class="entity-accordion-item-add">+</span> Pat Gelsinger</div>
              </div>
            </div>

            <!-- Organizations Accordion -->
            <div class="entity-accordion" data-type="organizations">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">üè¢</span>
                  <span class="entity-accordion-label">Organizations</span>
                  <span class="entity-accordion-count">7</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="SMIC" data-type="org"><span class="entity-accordion-item-add">+</span> SMIC</div>
                <div class="entity-accordion-item" data-name="Huawei" data-type="org"><span class="entity-accordion-item-add">+</span> Huawei</div>
                <div class="entity-accordion-item" data-name="TSMC" data-type="org"><span class="entity-accordion-item-add">+</span> TSMC</div>
                <div class="entity-accordion-item" data-name="Intel" data-type="org"><span class="entity-accordion-item-add">+</span> Intel</div>
                <div class="entity-accordion-item" data-name="NVIDIA" data-type="org"><span class="entity-accordion-item-add">+</span> NVIDIA</div>
                <div class="entity-accordion-item" data-name="ASML" data-type="org"><span class="entity-accordion-item-add">+</span> ASML</div>
                <div class="entity-accordion-item" data-name="Samsung" data-type="org"><span class="entity-accordion-item-add">+</span> Samsung</div>
              </div>
            </div>

            <!-- Factions Accordion -->
            <div class="entity-accordion" data-type="factions">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">‚öîÔ∏è</span>
                  <span class="entity-accordion-label">Factions</span>
                  <span class="entity-accordion-count">2</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="US Tech Alliance" data-type="faction"><span class="entity-accordion-item-add">+</span> US Tech Alliance</div>
                <div class="entity-accordion-item" data-name="China Semiconductor Coalition" data-type="faction"><span class="entity-accordion-item-add">+</span> China Semiconductor Coalition</div>
              </div>
            </div>

            <!-- Locations Accordion -->
            <div class="entity-accordion" data-type="locations">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">üìç</span>
                  <span class="entity-accordion-label">Locations</span>
                  <span class="entity-accordion-count">3</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="Shenzhen" data-type="location"><span class="entity-accordion-item-add">+</span> Shenzhen, China</div>
                <div class="entity-accordion-item" data-name="Taiwan" data-type="location"><span class="entity-accordion-item-add">+</span> Taiwan</div>
                <div class="entity-accordion-item" data-name="Silicon Valley" data-type="location"><span class="entity-accordion-item-add">+</span> Silicon Valley, USA</div>
              </div>
            </div>

            <!-- Events Accordion -->
            <div class="entity-accordion" data-type="events">
              <div class="entity-accordion-header">
                <div class="entity-accordion-left">
                  <svg class="entity-accordion-chevron" width="12" height="12" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6l4 4 4-4"/></svg>
                  <span class="filter-chip-icon">üìÖ</span>
                  <span class="entity-accordion-label">Events</span>
                  <span class="entity-accordion-count">2</span>
                </div>
                <button class="entity-accordion-add-all">Add all</button>
              </div>
              <div class="entity-accordion-body">
                <div class="entity-accordion-item" data-name="October 2023 Export Controls" data-type="event"><span class="entity-accordion-item-add">+</span> October 2023 Export Controls</div>
                <div class="entity-accordion-item" data-name="CHIPS Act Signing" data-type="event"><span class="entity-accordion-item-add">+</span> CHIPS Act Signing</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Notes about current implementation -->
        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: rgba(49, 105, 237, 0.08); border-radius: var(--border-radius); border: 1px solid rgba(49, 105, 237, 0.2);">
          <p style="font-size: var(--text-sm); color: var(--text-secondary); margin: 0;">
            <strong>Current behavior:</strong> All selected items are implicitly OR'd together. There's no way to express AND, NOT, or grouping logic. 
            The scope is stored as flat arrays: <code style="font-size: 11px; background: var(--bg-tertiary); padding: 2px 4px; border-radius: 3px;">{ personIds: [], organizationIds: [], keywords: [] }</code>
          </p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ==========================================
    // SVG Icons for Entities
    // ==========================================
    const entityIcons = {
      org: `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="2" y="3" width="12" height="11" rx="1"/>
        <path d="M5 7h6M5 10h4"/>
        <path d="M2 6h12"/>
      </svg>`,
      person: `<svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
        <circle cx="8" cy="5" r="2.5"/>
        <path d="M3 14c0-2.5 2-4.5 5-4.5s5 2 5 4.5"/>
      </svg>`
    };

    // ==========================================
    // Mock Entities
    // ==========================================
    const mockEntities = [
      { name: 'SMIC', type: 'org' },
      { name: 'Huawei', type: 'org' },
      { name: 'TSMC', type: 'org' },
      { name: 'Intel', type: 'org' },
      { name: 'NVIDIA', type: 'org' },
      { name: 'ASML', type: 'org' },
      { name: 'Samsung', type: 'org' },
      { name: 'Jensen Huang', type: 'person' },
      { name: 'Ren Zhengfei', type: 'person' },
      { name: 'Morris Chang', type: 'person' },
      { name: 'Pat Gelsinger', type: 'person' },
    ];

    const typeLabels = { org: 'Organizations', person: 'Persons' };

    // ==========================================
    // State
    // ==========================================
    const state = {
      mode: 'simple',
      operator: 'OR',
      chips: [],
      typeahead: {
        visible: false,
        query: '',
        items: [],
        selectedIndex: 0,
        triggerNode: null,
        searchStart: 0
      },
      parenDepth: 0
    };

    // ==========================================
    // Simple Mode Functions
    // ==========================================
    function addChip(name, type) {
      if (state.chips.some(c => c.name === name && c.type === type)) return;
      state.chips.push({ name, type });
      renderChips();
    }

    function removeChip(name) {
      state.chips = state.chips.filter(c => c.name !== name);
      renderChips();
    }

    function renderChips() {
      const container = document.getElementById('simple-chips');
      const input = document.getElementById('simple-input');
      container.querySelectorAll('.filter-chip').forEach(c => c.remove());
      
      state.chips.forEach(chip => {
        const el = document.createElement('span');
        el.className = 'filter-chip';
        el.dataset.type = chip.type;
        el.dataset.name = chip.name;
        const icon = chip.type === 'org' ? 'üè¢' : 'üë§';
        el.innerHTML = `<span class="filter-chip-icon">${icon}</span>${escapeHtml(chip.name)}<span class="remove">√ó</span>`;
        container.insertBefore(el, input);
      });
    }

    // ==========================================
    // Rich Editor Functions
    // ==========================================
    function createEntityChip(name, type) {
      const chip = document.createElement('span');
      chip.className = `entity-chip ${type}`;
      chip.contentEditable = 'false';
      chip.dataset.entityType = type;
      chip.dataset.entityName = name;
      chip.innerHTML = `${entityIcons[type]}<span>${escapeHtml(name)}</span>`;
      return chip;
    }

    function insertEntityAtCursor(name, type) {
      const editor = document.getElementById('rich-editor');
      const selection = window.getSelection();
      
      if (!selection.rangeCount) {
        editor.focus();
        return;
      }

      // Remove the @query text if present
      if (state.typeahead.query) {
        const range = selection.getRangeAt(0);
        
        // Find and remove @query
        const textNode = range.startContainer;
        if (textNode.nodeType === Node.TEXT_NODE) {
          const text = textNode.textContent;
          const atPos = text.lastIndexOf('@', range.startOffset);
          if (atPos !== -1) {
            // Remove @query
            textNode.textContent = text.slice(0, atPos) + text.slice(range.startOffset);
            range.setStart(textNode, atPos);
            range.collapse(true);
          }
        }
      }

      // Create and insert the chip
      const chip = createEntityChip(name, type);
      const range = selection.getRangeAt(0);
      range.insertNode(chip);
      
      // Add a space after and move cursor there
      const space = document.createTextNode('\u00A0');
      chip.after(space);
      range.setStartAfter(space);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);

      hideTypeahead();
      updateParseTree();
    }

    function insertOperator(op) {
      const editor = document.getElementById('rich-editor');
      const selection = window.getSelection();
      
      if (!selection.rangeCount) {
        editor.focus();
        return;
      }

      const range = selection.getRangeAt(0);
      const text = document.createTextNode(` ${op} `);
      range.insertNode(text);
      range.setStartAfter(text);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);

      editor.focus();
      updateParseTree();
    }

    function insertParen(paren) {
      const editor = document.getElementById('rich-editor');
      const selection = window.getSelection();
      
      if (!selection.rangeCount) {
        editor.focus();
        return;
      }

      const range = selection.getRangeAt(0);
      const text = document.createTextNode(paren === '(' ? '( ' : ' )');
      range.insertNode(text);
      range.setStartAfter(text);
      range.collapse(true);
      selection.removeAllRanges();
      selection.addRange(range);

      if (paren === '(') {
        state.parenDepth++;
      } else {
        state.parenDepth = Math.max(0, state.parenDepth - 1);
      }

      editor.focus();
      updateParseTree();
    }

    // ==========================================
    // Typeahead Functions
    // ==========================================
    function showTypeahead(query) {
      const popup = document.getElementById('typeahead-popup');
      state.typeahead.query = query;
      
      // Filter entities
      const filtered = mockEntities.filter(e => 
        e.name.toLowerCase().includes(query.toLowerCase())
      );
      
      if (filtered.length === 0) {
        hideTypeahead();
        return;
      }

      state.typeahead.items = filtered;
      state.typeahead.selectedIndex = 0;
      state.typeahead.visible = true;

      // Group by type
      const grouped = {};
      filtered.forEach(e => {
        if (!grouped[e.type]) grouped[e.type] = [];
        grouped[e.type].push(e);
      });

      // Render
      let html = `<div class="typeahead-header">Matching: <strong>${escapeHtml(query)}</strong></div>`;
      let itemIndex = 0;

      for (const [type, items] of Object.entries(grouped)) {
        html += `<div class="typeahead-section">
          <div class="typeahead-section-label">${typeLabels[type] || type}</div>
          ${items.map(e => {
            const selected = itemIndex === state.typeahead.selectedIndex ? 'selected' : '';
            const idx = itemIndex;
            itemIndex++;
            return `<div class="typeahead-item ${selected}" data-index="${idx}" data-name="${escapeHtml(e.name)}" data-type="${e.type}">
              ${entityIcons[e.type]} ${escapeHtml(e.name)}
            </div>`;
          }).join('')}
        </div>`;
      }

      popup.innerHTML = html;
      
      // Position near cursor (simple: below editor top-left area)
      const editor = document.getElementById('rich-editor');
      const rect = editor.getBoundingClientRect();
      const selection = window.getSelection();
      
      if (selection.rangeCount) {
        const range = selection.getRangeAt(0);
        const cursorRect = range.getBoundingClientRect();
        
        // Position relative to editor container
        const editorParent = editor.parentElement;
        const parentRect = editorParent.getBoundingClientRect();
        
        popup.style.left = `${Math.max(0, cursorRect.left - parentRect.left)}px`;
        popup.style.top = `${cursorRect.bottom - parentRect.top + 4}px`;
      }
      
      popup.classList.add('visible');

      // Attach click handlers
      popup.querySelectorAll('.typeahead-item').forEach(item => {
        item.addEventListener('mousedown', (e) => {
          e.preventDefault(); // Prevent blur
          insertEntityAtCursor(item.dataset.name, item.dataset.type);
        });
      });
    }

    function hideTypeahead() {
      const popup = document.getElementById('typeahead-popup');
      popup.classList.remove('visible');
      state.typeahead.visible = false;
      state.typeahead.query = '';
      state.typeahead.items = [];
    }

    function updateTypeaheadSelection() {
      const items = document.querySelectorAll('#typeahead-popup .typeahead-item');
      items.forEach((item, i) => {
        item.classList.toggle('selected', i === state.typeahead.selectedIndex);
      });
    }


    // ==========================================
    // Parse Tree
    // ==========================================
    function getEditorContent() {
      const editor = document.getElementById('rich-editor');
      let result = '';
      const positionMap = []; // Maps string positions to {node, offset}
      
      function traverse(node) {
        if (node.nodeType === Node.TEXT_NODE) {
          const text = node.textContent;
          for (let i = 0; i < text.length; i++) {
            positionMap.push({ node, offset: i });
          }
          result += text;
        } else if (node.classList && node.classList.contains('entity-chip')) {
          // Entity chip - use quoted name for parsing
          const name = node.dataset.entityName;
          const quoted = `"${name}"`;
          // Map all positions in quoted string to the chip node
          for (let i = 0; i < quoted.length; i++) {
            positionMap.push({ node, offset: i, isChip: true });
          }
          result += quoted;
        } else if (!node.classList || !node.classList.contains('error-marker')) {
          // Skip error markers, traverse other nodes
          node.childNodes.forEach(traverse);
        }
      }
      
      traverse(editor);
      
      // Trim and adjust position map
      const trimmedResult = result.replace(/\u00A0/g, ' ').trim();
      const startTrim = result.replace(/\u00A0/g, ' ').length - result.replace(/\u00A0/g, ' ').trimStart().length;
      
      return {
        text: trimmedResult,
        positionMap: positionMap.slice(startTrim)
      };
    }

    function clearErrorMarkers() {
      const editor = document.getElementById('rich-editor');
      editor.querySelectorAll('.error-marker').forEach(marker => marker.remove());
    }

    function insertErrorMarker(positionMap, errorPos) {
      if (!positionMap || positionMap.length === 0) return;
      
      // Find the position in the map (clamp to valid range)
      const mapIndex = Math.min(errorPos, positionMap.length - 1);
      const posInfo = positionMap[mapIndex];
      
      if (!posInfo) return;
      
      // Create the error marker
      const marker = document.createElement('span');
      marker.className = 'error-marker';
      marker.title = 'Error here';
      
      if (posInfo.isChip) {
        // Insert after the chip
        posInfo.node.after(marker);
      } else if (posInfo.node.nodeType === Node.TEXT_NODE) {
        // Split the text node and insert marker
        const textNode = posInfo.node;
        const offset = posInfo.offset;
        
        if (offset < textNode.textContent.length) {
          // Split at the error position
          const afterText = textNode.splitText(offset);
          textNode.after(marker);
        } else {
          // Insert at end
          textNode.after(marker);
        }
      }
    }

    function updateParseTree() {
      const editor = document.getElementById('rich-editor');
      const treeContainer = document.getElementById('parsed-tree');
      const status = document.getElementById('editor-status');
      
      // Clear existing error markers
      clearErrorMarkers();
      
      const { text: content, positionMap } = getEditorContent();
      
      if (!content) {
        treeContainer.innerHTML = '<div class="tree-empty">Start building to see expression structure</div>';
        status.className = 'editor-status valid';
        status.innerHTML = '<span>‚úì</span><span>Ready ‚Äî type @ to insert an entity</span>';
        return;
      }

      try {
        const parser = new BooleanParser(content);
        const ast = parser.parse();
        treeContainer.innerHTML = renderTree(ast);
        status.className = 'editor-status valid';
        status.innerHTML = '<span>‚úì</span><span>Valid expression</span>';
      } catch (error) {
        treeContainer.innerHTML = `<div class="tree-empty" style="color: var(--accent-danger);">${escapeHtml(error.message)}</div>`;
        status.className = 'editor-status error';
        status.innerHTML = `<span>‚úó</span><span>Syntax error at position ${error.position || '?'}</span>`;
        
        // Insert error marker at the error position
        if (typeof error.position === 'number') {
          insertErrorMarker(positionMap, error.position);
        }
      }
    }

    // ==========================================
    // Boolean Parser
    // ==========================================
    class BooleanParser {
      constructor(input) {
        this.input = input.trim();
        this.pos = 0;
      }

      parse() {
        if (!this.input) return null;
        const result = this.parseOr();
        this.skipWhitespace();
        if (this.pos < this.input.length) {
          throw this.createError(`Unexpected: "${this.input[this.pos]}"`);
        }
        return result;
      }

      createError(message) {
        const error = new Error(message);
        error.position = this.pos;
        return error;
      }

      skipWhitespace() {
        while (this.pos < this.input.length && /\s/.test(this.input[this.pos])) {
          this.pos++;
        }
      }

      parseOr() {
        let left = this.parseAnd();
        while (true) {
          this.skipWhitespace();
          if (this.matchKeyword('OR')) {
            const right = this.parseAnd();
            left = left.type === 'OR' 
              ? { type: 'OR', children: [...left.children, right] }
              : { type: 'OR', children: [left, right] };
          } else break;
        }
        return left;
      }

      parseAnd() {
        let left = this.parseNot();
        while (true) {
          this.skipWhitespace();
          if (this.matchKeyword('AND')) {
            const right = this.parseNot();
            left = left.type === 'AND'
              ? { type: 'AND', children: [...left.children, right] }
              : { type: 'AND', children: [left, right] };
          } else break;
        }
        return left;
      }

      parseNot() {
        this.skipWhitespace();
        if (this.matchKeyword('NOT')) {
          return { type: 'NOT', child: this.parseNot() };
        }
        return this.parsePrimary();
      }

      parsePrimary() {
        this.skipWhitespace();
        if (this.pos >= this.input.length) {
          throw this.createError('Unexpected end');
        }
        if (this.input[this.pos] === ')') {
          throw this.createError('Unexpected )');
        }
        if (this.input[this.pos] === '(') {
          this.pos++;
          const result = this.parseOr();
          this.skipWhitespace();
          if (this.pos >= this.input.length || this.input[this.pos] !== ')') {
            throw this.createError('Missing )');
          }
          this.pos++;
          return result;
        }
        if (this.input[this.pos] === '"') {
          this.pos++;
          let term = '';
          while (this.pos < this.input.length && this.input[this.pos] !== '"') {
            term += this.input[this.pos++];
          }
          if (this.pos >= this.input.length) {
            throw this.createError('Unterminated quote');
          }
          this.pos++;
          return { type: 'TERM', value: term, isQuoted: true };
        }
        let term = '';
        while (this.pos < this.input.length) {
          const char = this.input[this.pos];
          if (/[\s()"]/.test(char)) break;
          const remaining = this.input.slice(this.pos).toUpperCase();
          if (['AND ', 'OR ', 'NOT '].some(op => remaining.startsWith(op))) break;
          term += char;
          this.pos++;
        }
        if (!term) throw this.createError('Expected term');
        return { type: 'TERM', value: term };
      }

      matchKeyword(keyword) {
        const remaining = this.input.slice(this.pos);
        const regex = new RegExp(`^${keyword}(?:[\\s("']|$)`, 'i');
        if (regex.test(remaining)) {
          this.pos += keyword.length;
          return true;
        }
        return false;
      }
    }

    function renderTree(node, isRoot = true) {
      if (!node) return '';
      const rootClass = isRoot ? 'tree-root' : '';
      
      if (node.type === 'TERM') {
        return `<div class="tree-node ${rootClass}">
          <span class="node-term">${escapeHtml(node.value)}</span>
        </div>`;
      }
      
      if (node.type === 'NOT') {
        return `<div class="tree-node ${rootClass}">
          <span class="operator-badge operator-not">NOT</span>
          ${renderTree(node.child, false)}
        </div>`;
      }
      
      if (node.type === 'AND' || node.type === 'OR') {
        const opClass = node.type === 'AND' ? 'operator-and' : 'operator-or';
        const children = node.children.map(c => renderTree(c, false)).join('');
        return `<div class="tree-node ${rootClass}">
          <span class="operator-badge ${opClass}">${node.type}</span>
          ${children}
        </div>`;
      }
      return '';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ==========================================
    // Mode Switching
    // ==========================================
    function switchMode(mode) {
      state.mode = mode;
      document.querySelectorAll('.mode-tab').forEach(t => t.classList.toggle('active', t.dataset.mode === mode));
      document.querySelectorAll('.mode-panel').forEach(p => p.classList.toggle('active', p.id === `${mode}-mode`));
      
      if (mode === 'advanced') {
        document.getElementById('rich-editor').focus();
      }
    }

    // ==========================================
    // Event Listeners
    // ==========================================
    
    // Mode tabs
    document.querySelectorAll('.mode-tab').forEach(tab => {
      tab.addEventListener('click', () => switchMode(tab.dataset.mode));
    });

    // Simple mode
    document.getElementById('simple-operator')?.addEventListener('click', (e) => {
      const btn = e.target.closest('.operator-toggle-btn');
      if (btn) {
        state.operator = btn.dataset.op;
        document.querySelectorAll('#simple-operator .operator-toggle-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
      }
    });

    document.getElementById('simple-chips')?.addEventListener('click', (e) => {
      if (e.target.classList.contains('remove')) {
        const chip = e.target.closest('.filter-chip');
        if (chip) removeChip(chip.dataset.name);
      }
    });

    document.getElementById('simple-input')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        e.preventDefault();
        addChip(e.target.value.trim(), 'keyword');
        e.target.value = '';
      }
    });

    // Rich Editor
    const richEditor = document.getElementById('rich-editor');

    richEditor?.addEventListener('input', (e) => {
      updateParseTree();
      
      // Check for @ trigger
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      
      const range = selection.getRangeAt(0);
      const textNode = range.startContainer;
      
      if (textNode.nodeType === Node.TEXT_NODE) {
        const text = textNode.textContent;
        const cursorPos = range.startOffset;
        
        // Find @ before cursor
        const beforeCursor = text.slice(0, cursorPos);
        const atIndex = beforeCursor.lastIndexOf('@');
        
        if (atIndex !== -1) {
          const query = beforeCursor.slice(atIndex + 1);
          if (query.length >= 0 && !query.includes(' ')) {
            showTypeahead(query);
            return;
          }
        }
      }
      
      hideTypeahead();
    });

    richEditor?.addEventListener('keydown', (e) => {
      // Handle @ key
      if (e.key === '@') {
        // Will be handled by input event
        return;
      }

      // Handle ( key
      if (e.key === '(' && !state.typeahead.visible) {
        e.preventDefault();
        insertParen('(');
        return;
      }

      // Handle typeahead navigation
      if (state.typeahead.visible) {
        if (e.key === 'Tab' || e.key === 'Enter') {
          e.preventDefault();
          const selected = state.typeahead.items[state.typeahead.selectedIndex];
          if (selected) {
            insertEntityAtCursor(selected.name, selected.type);
          }
          return;
        }
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          state.typeahead.selectedIndex = Math.min(
            state.typeahead.selectedIndex + 1,
            state.typeahead.items.length - 1
          );
          updateTypeaheadSelection();
          return;
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          state.typeahead.selectedIndex = Math.max(
            state.typeahead.selectedIndex - 1,
            0
          );
          updateTypeaheadSelection();
          return;
        }
        if (e.key === 'Escape') {
          e.preventDefault();
          hideTypeahead();
          return;
        }
      }

    });

    richEditor?.addEventListener('blur', () => {
      // Delay to allow popup clicks
      setTimeout(() => {
        hideTypeahead();
      }, 150);
    });

    // Accordion toggles
    document.querySelectorAll('.entity-accordion-header').forEach(header => {
      header.addEventListener('click', (e) => {
        if (e.target.closest('.entity-accordion-add-all')) return;
        header.closest('.entity-accordion').classList.toggle('expanded');
      });
    });

    // Accordion item clicks (for advanced mode)
    document.querySelectorAll('#advanced-accordions .entity-accordion-item').forEach(item => {
      item.addEventListener('click', () => {
        const name = item.dataset.name;
        const type = item.dataset.type;
        if (name && type) {
          document.getElementById('rich-editor').focus();
          setTimeout(() => insertEntityAtCursor(name, type), 50);
        }
      });
    });

    // Simple mode accordion items
    document.querySelectorAll('#simple-accordions .entity-accordion-item').forEach(item => {
      item.addEventListener('click', () => {
        const name = item.dataset.name;
        const type = item.dataset.type;
        if (name && type) {
          addChip(name, type);
        }
      });
    });

    // Clear button
    document.getElementById('clear-btn')?.addEventListener('click', () => {
      if (state.mode === 'simple') {
        state.chips = [];
        renderChips();
      } else {
        document.getElementById('rich-editor').innerHTML = '';
        state.parenDepth = 0;
        updateParseTree();
      }
    });

    // Dropdown functionality
    document.querySelectorAll('.nav-dropdown').forEach(dropdown => {
      const trigger = dropdown.querySelector('.nav-dropdown-trigger, .avatar-trigger');
      trigger?.addEventListener('click', (e) => {
        e.stopPropagation();
        document.querySelectorAll('.nav-dropdown').forEach(d => {
          if (d !== dropdown) d.classList.remove('open');
        });
        dropdown.classList.toggle('open');
      });
    });
    document.addEventListener('click', () => {
      document.querySelectorAll('.nav-dropdown').forEach(d => d.classList.remove('open'));
    });

    // Initialize
    renderChips();

    // ==========================================
    // ScopeSelector Demo Interactivity
    // ==========================================
    const scopeDemoState = {
      chips: []
    };

    function renderScopeDemoChips() {
      const container = document.getElementById('scope-demo-chips');
      if (!container) return;
      
      if (scopeDemoState.chips.length === 0) {
        container.innerHTML = '<span class="scope-chips-empty" style="color: var(--text-muted); font-size: var(--text-xs);">No items selected</span>';
      } else {
        container.innerHTML = scopeDemoState.chips.map(chip => `
          <span class="scope-chip" data-name="${escapeHtml(chip.name)}" style="display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: var(--text-xs);">
            ${escapeHtml(chip.name)}
            <button class="chip-remove" style="background: none; border: none; cursor: pointer; font-size: 14px; line-height: 1; opacity: 0.5; padding: 0;">&times;</button>
          </span>
        `).join('');
      }
      
      // Update save button state
      const saveBtn = document.querySelector('#scope-selector-demo .scope-save-filter-btn');
      if (saveBtn) {
        saveBtn.disabled = scopeDemoState.chips.length === 0;
      }
    }

    function addScopeDemoChip(name, type) {
      if (scopeDemoState.chips.some(c => c.name === name)) return;
      scopeDemoState.chips.push({ name, type });
      renderScopeDemoChips();
    }

    function removeScopeDemoChip(name) {
      scopeDemoState.chips = scopeDemoState.chips.filter(c => c.name !== name);
      renderScopeDemoChips();
    }

    // Scope demo accordion toggles
    document.querySelectorAll('#scope-selector-demo .entity-accordion-header').forEach(header => {
      header.addEventListener('click', (e) => {
        if (e.target.closest('.entity-accordion-add-all')) return;
        header.closest('.entity-accordion').classList.toggle('expanded');
      });
    });

    // Scope demo entity item clicks
    document.querySelectorAll('#scope-selector-demo .entity-accordion-item').forEach(item => {
      item.addEventListener('click', () => {
        const name = item.dataset.name;
        const type = item.dataset.type;
        if (name) {
          addScopeDemoChip(name, type || 'entity');
        }
      });
    });

    // Scope demo chip removal
    document.getElementById('scope-demo-chips')?.addEventListener('click', (e) => {
      const removeBtn = e.target.closest('.chip-remove');
      if (removeBtn) {
        const chip = removeBtn.closest('.scope-chip');
        if (chip) {
          removeScopeDemoChip(chip.dataset.name);
        }
      }
    });

    // Scope demo search/keyword input
    document.getElementById('scope-demo-search')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && e.target.value.trim()) {
        e.preventDefault();
        addScopeDemoChip(`"${e.target.value.trim()}"`, 'keyword');
        e.target.value = '';
      }
    });

    // ==========================================
    // Save Filter Dialog
    // ==========================================
    const saveDialogOverlay = document.getElementById('save-dialog-overlay');
    const saveDialogNameInput = document.getElementById('save-filter-name');
    const saveDialogDescInput = document.getElementById('save-filter-description');
    const saveDialogPreview = document.getElementById('save-dialog-preview-content');
    const saveDialogSummary = document.getElementById('save-dialog-summary');

    function getFilterSummary() {
      if (state.mode === 'simple') {
        const count = state.chips.length;
        return {
          count,
          text: `${count} item${count !== 1 ? 's' : ''} with ${state.operator === 'OR' ? 'ANY' : 'ALL'} logic`
        };
      } else {
        // Advanced mode - count from the editor
        const editor = document.getElementById('rich-editor');
        const chips = editor?.querySelectorAll('.entity-chip') || [];
        const content = getEditorContent();
        const hasContent = content.text.trim().length > 0;
        return {
          count: chips.length,
          text: hasContent ? 'Boolean expression' : 'Empty expression',
          expression: content.text
        };
      }
    }

    function openSaveDialog() {
      const summary = getFilterSummary();
      
      // Update summary text
      if (saveDialogSummary) {
        saveDialogSummary.innerHTML = `<strong>${summary.count}</strong> ${summary.text}`;
      }
      
      // Update preview
      if (saveDialogPreview) {
        if (state.mode === 'simple') {
          const chipNames = state.chips.map(c => c.name).join(` ${state.operator} `);
          saveDialogPreview.textContent = chipNames || '(empty)';
        } else {
          saveDialogPreview.textContent = summary.expression || '(empty)';
        }
      }
      
      // Reset form
      if (saveDialogNameInput) saveDialogNameInput.value = '';
      if (saveDialogDescInput) saveDialogDescInput.value = '';
      
      // Show dialog
      saveDialogOverlay?.classList.add('visible');
      
      // Focus name input
      setTimeout(() => saveDialogNameInput?.focus(), 100);
    }

    function closeSaveDialog() {
      saveDialogOverlay?.classList.remove('visible');
    }

    function saveFilter() {
      const name = saveDialogNameInput?.value.trim();
      if (!name) {
        saveDialogNameInput?.classList.add('input-error');
        saveDialogNameInput?.focus();
        setTimeout(() => saveDialogNameInput?.classList.remove('input-error'), 1000);
        return;
      }
      
      const description = saveDialogDescInput?.value.trim();
      const summary = getFilterSummary();
      
      // Mock save - in real implementation this would call dataStore.createSearchFilter()
      const filter = {
        id: 'filter-' + Date.now(),
        name,
        description: description || undefined,
        mode: state.mode,
        // For simple mode
        ...(state.mode === 'simple' && {
          operator: state.operator,
          scope: {
            personIds: state.chips.filter(c => c.type === 'person').map(c => c.name),
            organizationIds: state.chips.filter(c => c.type === 'org').map(c => c.name),
            keywords: state.chips.filter(c => !c.type || c.type === 'keyword').map(c => c.name)
          }
        }),
        // For advanced mode
        ...(state.mode !== 'simple' && {
          booleanExpression: summary.expression
        }),
        createdAt: new Date().toISOString()
      };
      
      console.log('Saved filter:', filter);
      
      // Show success feedback
      alert(`Filter "${name}" saved successfully!\n\nIn the real app, this would be stored in the dataStore and available throughout the application.`);
      
      closeSaveDialog();
    }

    // Save dialog event listeners
    document.getElementById('save-dialog-close')?.addEventListener('click', closeSaveDialog);
    document.getElementById('save-dialog-cancel')?.addEventListener('click', closeSaveDialog);
    document.getElementById('save-dialog-save')?.addEventListener('click', saveFilter);

    saveDialogOverlay?.addEventListener('click', (e) => {
      if (e.target === saveDialogOverlay) closeSaveDialog();
    });

    saveDialogNameInput?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        saveFilter();
      } else if (e.key === 'Escape') {
        closeSaveDialog();
      }
    });

    // Wire up the Save Filter button in footer
    document.querySelector('.filter-actions-right .btn-primary')?.addEventListener('click', (e) => {
      e.preventDefault();
      openSaveDialog();
    });
  </script>

  <!-- Save Filter Dialog -->
  <div class="save-dialog-overlay" id="save-dialog-overlay">
    <div class="save-dialog">
      <div class="save-dialog-header">
        <h3>Save Search Filter</h3>
        <button class="save-dialog-close" id="save-dialog-close" aria-label="Close">&times;</button>
      </div>
      <div class="save-dialog-body">
        <p class="save-dialog-description">
          Save your current selection as a reusable filter. You can apply this filter to monitors 
          and other searches throughout the app.
        </p>
        <p class="save-dialog-summary" id="save-dialog-summary">
          <strong>0</strong> items will be saved in this filter.
        </p>
        
        <div class="form-group">
          <label class="form-label" for="save-filter-name">
            Filter Name <span class="required">*</span>
          </label>
          <input 
            type="text" 
            id="save-filter-name" 
            class="form-input" 
            placeholder="e.g., Key Executives, China Tech Orgs..."
          />
        </div>
        
        <div class="form-group">
          <label class="form-label" for="save-filter-description">
            Description <span class="optional">(optional)</span>
          </label>
          <input 
            type="text" 
            id="save-filter-description" 
            class="form-input" 
            placeholder="Brief description of this filter..."
          />
        </div>
        
        <div class="save-dialog-preview">
          <div class="save-dialog-preview-label">Preview</div>
          <div class="save-dialog-preview-content" id="save-dialog-preview-content">
            (empty)
          </div>
        </div>
      </div>
      <div class="save-dialog-footer">
        <button class="btn" id="save-dialog-cancel">Cancel</button>
        <button class="btn btn-primary" id="save-dialog-save">Save Filter</button>
      </div>
    </div>
  </div>
</body>
</html>
